<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Work Hours Tracker</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h1 { text-align: center; }
  .tabs { display: flex; margin-bottom: 10px; }
  .tab { padding: 8px 12px; margin-right: 5px; cursor: pointer; background: #eee; border-radius: 5px; }
  .tab.active { background: #ddd; font-weight: bold; }
  .controls { margin-bottom: 10px; }
  button { margin-right: 5px; padding: 5px 10px; font-weight: bold; }
  button.recording { color: red; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
  th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
  .duration { width: 80px; text-align: center; }
  .delete { color: red; cursor: pointer; }
  .summary { margin-top: 10px; font-weight: bold; }
  .recording-dot { display: inline-block; width: 10px; height: 10px; background: red; border-radius: 50%; animation: blink 1s infinite; margin-left: 5px; }
  @keyframes blink { 0%, 50%, 100% { opacity: 1; } 25%, 75% { opacity: 0; } }
  input { width: 100%; box-sizing: border-box; }
  tr.dragging { opacity: 0.5; }
</style>
</head>
<body>
<h1>Work Hours Tracker</h1>

<div class="tabs" id="dayTabs"></div>
<div class="controls">
  <button id="newTaskBtn">New</button>
  <button id="stopTaskBtn">Stop</button>
  <button id="addDayBtn">Add Day</button>
</div>

<table id="taskTable">
  <thead>
    <tr>
      <th>Start</th>
      <th>End</th>
      <th>Description</th>
      <th>Duration</th>
      <th>Delete</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="summary" id="dailySummary"></div>

<script>
const taskTable = document.querySelector('#taskTable tbody');
const dayTabs = document.getElementById('dayTabs');
const newTaskBtn = document.getElementById('newTaskBtn');
const stopTaskBtn = document.getElementById('stopTaskBtn');
const addDayBtn = document.getElementById('addDayBtn');

let data = JSON.parse(localStorage.getItem('workHours')) || {};
let currentDay = formatDate(new Date());
if (!data[currentDay]) data[currentDay] = [];

function saveData() {
  localStorage.setItem('workHours', JSON.stringify(data));
}

function formatDate(d) {
  return d.toISOString().split('T')[0];
}

function formatTabName(dateStr) {
  const today = new Date();
  const d = new Date(dateStr);
  const diff = Math.floor((today - d)/(1000*60*60*24));
  if (diff === 0) return 'Today';
  if (diff === 1) return 'Yesterday';
  const options = { weekday: 'short', day: 'numeric', month: 'short' };
  return d.getMonth() === today.getMonth() ? d.toLocaleDateString('en-US', options) : d.toLocaleDateString('en-US', { weekday:'short', day:'numeric', month:'short' });
}

function renderTabs() {
  dayTabs.innerHTML = '';
  Object.keys(data).sort((a,b) => new Date(b)-new Date(a)).forEach(day => {
    const tab = document.createElement('div');
    tab.className = 'tab' + (day === currentDay ? ' active' : '');
    tab.textContent = formatTabName(day);
    tab.onclick = () => { currentDay = day; renderTasks(); renderTabs(); };
    dayTabs.appendChild(tab);
  });
}

function renderTasks() {
  taskTable.innerHTML = '';
  data[currentDay].forEach((task, idx) => {
    const tr = document.createElement('tr');
    tr.draggable = true;
    tr.dataset.idx = idx;

    const startInput = document.createElement('input');
    startInput.type = 'time';
    startInput.value = task.start;
    startInput.onchange = e => { task.start = e.target.value; updateDurations(); saveData(); };

    const endInput = document.createElement('input');
    endInput.type = 'time';
    endInput.value = task.end || '';
    endInput.onchange = e => { task.end = e.target.value; updateDurations(); saveData(); };

    const descInput = document.createElement('input');
    descInput.type = 'text';
    descInput.value = task.desc;
    descInput.onchange = e => { task.desc = e.target.value; updateSummary(); saveData(); };

    const durationTd = document.createElement('td');
    durationTd.className = 'duration';

    const deleteTd = document.createElement('td');
    const delBtn = document.createElement('span');
    delBtn.textContent = 'X';
    delBtn.className = 'delete';
    delBtn.onclick = () => { if(confirm('Delete this task?')) { data[currentDay].splice(idx,1); saveData(); renderTasks(); } };
    deleteTd.appendChild(delBtn);

    tr.appendChild(cellWith(startInput));
    tr.appendChild(cellWith(endInput));
    tr.appendChild(cellWith(descInput));
    tr.appendChild(durationTd);
    tr.appendChild(deleteTd);

    taskTable.appendChild(tr);

    // Drag & drop
    tr.addEventListener('dragstart', e => tr.classList.add('dragging'));
    tr.addEventListener('dragend', e => { tr.classList.remove('dragging'); saveOrder(); });
    tr.addEventListener('dragover', e => { e.preventDefault(); const dragging = document.querySelector('.dragging'); if(dragging !== tr) taskTable.insertBefore(dragging,tr.nextSibling); });
  });
  updateDurations();
  updateSummary();
}

function cellWith(element) {
  const td = document.createElement('td');
  td.appendChild(element);
  return td;
}

function updateDurations() {
  const rows = taskTable.querySelectorAll('tr');
  rows.forEach((tr, idx) => {
    const task = data[currentDay][idx];
    const durTd = tr.querySelector('.duration');
    if(task.start && task.end){
      const [sh, sm] = task.start.split(':').map(Number);
      const [eh, em] = task.end.split(':').map(Number);
      let dur = (eh*60+em) - (sh*60+sm);
      if(dur < 0) dur = 0;
      durTd.textContent = Math.floor(dur/60) + 'h ' + (dur%60) + 'm';
    } else {
      durTd.textContent = '';
    }
  });
  updateSummary();
}

function updateSummary() {
  const summaryDiv = document.getElementById('dailySummary');
  const summary = {};
  data[currentDay].forEach(task => {
    if(task.desc){
      if(!summary[task.desc]) summary[task.desc] = 0;
      if(task.start && task.end){
        const [sh, sm] = task.start.split(':').map(Number);
        const [eh, em] = task.end.split(':').map(Number);
        let dur = (eh*60+em) - (sh*60+sm);
        if(dur > 0) summary[task.desc] += dur;
      }
    }
  });
  summaryDiv.innerHTML = 'Summary: ' + Object.entries(summary).map(([desc,dur]) => `${desc}: ${Math.floor(dur/60)}h ${dur%60}m`).join(', ');
}

function saveOrder() {
  const rows = taskTable.querySelectorAll('tr');
  data[currentDay] = Array.from(rows).map(tr => data[currentDay][tr.dataset.idx]);
  saveData();
}

function stopCurrentTask() {
  const running = data[currentDay].find(t => !t.end);
  if(running) running.end = new Date().toTimeString().slice(0,5);
  saveData();
  renderTasks();
}

function startNewTask() {
  stopCurrentTask();
  const now = new Date();
  const newTask = { start: now.toTimeString().slice(0,5), end: '', desc: '' };
  data[currentDay].push(newTask);
  saveData();
  renderTasks();
}

newTaskBtn.onclick = startNewTask;
stopTaskBtn.onclick = stopCurrentTask;

addDayBtn.onclick = () => {
  let input = prompt('Enter date (YYYY-MM-DD)');
  if(!input) return;
  if(data[input]) { alert('Day already exists'); return; }
  data[input] = [];
  currentDay = input;
  saveData();
  renderTabs();
  renderTasks();
};

renderTabs();
renderTasks();
</script>
</body>
</html>
