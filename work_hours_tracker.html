<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Simple Timesheet</title>
    <style>
        :root {
            --bg: #0f1115;
            --card: #171a21;
            --ink: #e8e8e8;
            --muted: #a7a7a7;
            --accent: #82cfff;
            --line: #262a33;
            --danger: #ff4d4d;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            background: var(--bg);
            color: var(--ink);
        }

        .wrap {
            max-width: 980px;
            margin: 20px auto;
            padding: 0 16px;
        }

        h1 {
            font-size: 20px;
            font-weight: 650;
            margin: 0 0 12px;
            letter-spacing: .2px;
        }

        .bar {
            display: flex;
            gap: 8px;
            align-items: center;
            margin: 8px 0 12px;
            flex-wrap: wrap;
        }

        button {
            background: var(--card);
            color: var(--ink);
            border: 2px solid var(--line);
            border-radius: 10px;
            padding: 10px 14px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
        }

        button:hover {
            border-color: var(--accent);
        }

        button.primary {
            background: linear-gradient(180deg, #115b83, #083447);
            color: #fff;
            border-color: #083447;
        }

        button.danger {
            background: linear-gradient(180deg, #7b2222, #501515);
            color: #fff;
            border-color: #501515;
        }

        .tabs {
            display: flex;
            gap: 6px;
            overflow: auto;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--line);
            margin-bottom: 12px;
        }

        .tab {
            padding: 8px 10px;
            border: 1px solid var(--line);
            border-bottom: none;
            border-radius: 10px 10px 0 0;
            background: var(--card);
            color: var(--muted);
            cursor: pointer;
            white-space: nowrap;
        }

        .tab.active {
            color: var(--ink);
            border-color: var(--accent);
            font-weight: 700;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border-bottom: 1px solid var(--line);
            padding: 8px;
            text-align: left;
        }

        th {
            color: var(--muted);
            font-weight: 600;
            font-size: 12px;
            letter-spacing: .3px;
        }

        input[type="time"],
        input[type="text"],
        input[type="date"] {
            width: 100%;
            box-sizing: border-box;
            background: #0f1218;
            color: var(--ink);
            border: 1px solid var(--line);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 14px;
        }

        input[type="text"]::placeholder {
            color: #6c7280;
        }

        .muted {
            color: var(--muted);
            font-size: 12px;
        }

        .summary {
            margin-top: 12px;
        }

        .summary table td,
        .summary table th {
            padding: 6px 8px;
        }

        .running-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--danger);
            font-weight: 700;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--danger);
            animation: blink 1s infinite;
            box-shadow: 0 0 8px rgba(255, 77, 77, 0.6);
        }

        @keyframes blink {
            0%, 50% {
                opacity: 1;
            }
            25%, 75% {
                opacity: 0.15;
            }
        }

        .row-actions {
            display: flex;
            gap: 4px;
        }

        .draggable {
            cursor: grab;
        }

        .small {
            font-size: 13px;
            padding: 8px 10px;
        }

        .danger-small {
            background: transparent;
            border: 1px solid var(--line);
            color: var(--muted);
            border-radius: 8px;
            padding: 6px 8px;
        }

        .inline-form {
            display: inline-flex;
            gap: 8px;
            align-items: center;
        }
    </style>
</head>
<body>
<div class="wrap">
    <h1>Simple Timesheet</h1>

    <div class="bar">
        <button id="newBtn" class="primary">● New</button>
        <button id="stopBtn" class="danger">■ Stop</button>
        <span id="runningPill" class="running-indicator" style="display:none;">
        <span class="dot"></span> Running
      </span>
        <span class="muted" id="dayTotal"></span>

        <div style="width:8px"></div>

        <div class="inline-form">
            <input type="date" id="addDayInput" title="Pick a date to create/open"/>
            <button id="addDayBtn" class="small">Add / Open Day</button>
        </div>

        <div class="inline-form" style="margin-left:8px;">
            <button id="editDayBtn" class="small">Edit Day</button>
            <input type="date" id="editDayInput" style="display:none;"/>
            <button id="saveEditDayBtn" class="small" style="display:none;">Save</button>
            <button id="cancelEditDayBtn" class="small" style="display:none;">Cancel</button>
        </div>

        <button id="deleteDayBtn" class="danger small" style="margin-left:auto;">Delete Day</button>
    </div>

    <div id="tabs" class="tabs"></div>

    <div class="card">
        <table>
            <thead>
            <tr>
                <th style="width:110px;">Start</th>
                <th style="width:110px;">End</th>
                <th>Description</th>
                <th style="width:80px; text-align:center;">Delete</th>
            </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
        <div id="summary" class="summary"></div>
    </div>

    <div style="height:40px"></div>
</div>

<script>
    (function () {
        'use strict';

        // === CONSTANTS ===
        const STORAGE_KEY = 'simpleTimesheetV3';

        // === UTILITIES ===
        const pad = (n) => String(n).padStart(2, '0');

        function todayKey() {
            const d = new Date();
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
        }

        function timeNow() {
            const d = new Date();
            return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        function parseHM(time) {
            if (!time || !/^\d{2}:\d{2}$/.test(time)) return null;
            const [h, m] = time.split(':').map(Number);
            if (h > 23 || m > 59) return null;
            return h * 60 + m;
        }

        function fmtHM(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${h}:${pad(m)}`;
        }

        function findLast(arr, predicate) {
            for (let i = arr.length - 1; i >= 0; i--) {
                if (predicate(arr[i])) return arr[i];
            }
            return null;
        }

        function uid() {
            return 'e' + Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;');
        }

        // === STATE MANAGEMENT ===
        let state = loadState();
        if (!state.days) state.days = {};
        if (!state.openDay) state.openDay = todayKey();
        ensureDay(state.openDay);
        saveState();

        function loadState() {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
            } catch (e) {
                return {};
            }
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function ensureDay(day) {
            if (!state.days[day]) state.days[day] = [];
        }

        function setOpenDay(day) {
            state.openDay = day;
            ensureDay(day);
            saveState();
            renderAll();
        }

        // === DOM REFERENCES ===
        const elements = {
            tabs: document.getElementById('tabs'),
            tbody: document.getElementById('tbody'),
            newBtn: document.getElementById('newBtn'),
            stopBtn: document.getElementById('stopBtn'),
            runningPill: document.getElementById('runningPill'),
            dayTotal: document.getElementById('dayTotal'),
            summary: document.getElementById('summary'),
            addDayInput: document.getElementById('addDayInput'),
            addDayBtn: document.getElementById('addDayBtn'),
            editDayBtn: document.getElementById('editDayBtn'),
            editDayInput: document.getElementById('editDayInput'),
            saveEditDayBtn: document.getElementById('saveEditDayBtn'),
            cancelEditDayBtn: document.getElementById('cancelEditDayBtn'),
            deleteDayBtn: document.getElementById('deleteDayBtn')
        };

        // === EVENT HANDLERS ===
        function onNew() {
            const entries = state.days[state.openDay];
            const running = findLast(entries, e => e.start && !e.end);

            if (running) {
                running.end = timeNow();
            }

            entries.push({
                id: uid(),
                start: timeNow(),
                end: '',
                desc: ''
            });

            saveState();
            renderAll(true);
            focusLastDescription();
        }

        function onStop() {
            const entries = state.days[state.openDay];
            const running = findLast(entries, e => e.start && !e.end);

            if (running && !running.end) {
                running.end = timeNow();
                saveState();
                renderAll();
            }
        }

        function onAddDay() {
            if (elements.addDayInput.value) {
                setOpenDay(elements.addDayInput.value);
                elements.addDayInput.value = '';
            }
        }

        function onEditDay() {
            elements.editDayInput.value = state.openDay;
            elements.editDayInput.style.display = 'inline-block';
            elements.saveEditDayBtn.style.display = 'inline-block';
            elements.cancelEditDayBtn.style.display = 'inline-block';
            elements.editDayInput.focus();
        }

        function onCancelEditDay() {
            elements.editDayInput.style.display = 'none';
            elements.saveEditDayBtn.style.display = 'none';
            elements.cancelEditDayBtn.style.display = 'none';
        }

        function onSaveEditDay() {
            const newDate = elements.editDayInput.value;
            const oldDate = state.openDay;

            if (!newDate) {
                alert('Pick a valid date');
                return;
            }

            if (newDate === oldDate) {
                onCancelEditDay();
                return;
            }

            // Handle existing target date
            if (state.days[newDate]) {
                if (!confirm('Target day already exists. Merge current entries into that day?')) {
                    return;
                }
                // Merge entries
                state.days[newDate] = (state.days[newDate] || []).concat(state.days[oldDate]);
            } else {
                // Move entries
                state.days[newDate] = state.days[oldDate];
            }

            delete state.days[oldDate];
            state.openDay = newDate;
            saveState();
            renderAll();
            onCancelEditDay();
        }

        function onDeleteDay() {
            if (!confirm('Delete all entries for this day? This cannot be undone.')) {
                return;
            }

            delete state.days[state.openDay];
            state.openDay = todayKey();
            ensureDay(state.openDay);
            saveState();
            renderAll();
        }

        // === EVENT LISTENERS ===
        elements.newBtn.addEventListener('click', onNew);
        elements.stopBtn.addEventListener('click', onStop);
        elements.addDayBtn.addEventListener('click', onAddDay);
        elements.editDayBtn.addEventListener('click', onEditDay);
        elements.cancelEditDayBtn.addEventListener('click', onCancelEditDay);
        elements.saveEditDayBtn.addEventListener('click', onSaveEditDay);
        elements.deleteDayBtn.addEventListener('click', onDeleteDay);

        // === RENDERING ===
        function renderAll(scrollBottom = false) {
            renderTabs();
            renderTable();
            renderSummary();
            updateRunningUI();
            updateDayTotal();

            if (scrollBottom) {
                elements.tbody.parentElement.scrollTop = elements.tbody.scrollHeight;
            }
        }

        function renderTabs() {
            const today = todayKey();
            const allDays = new Set(Object.keys(state.days || {}));
            allDays.add(today);

            // Order: today first, then others newest to oldest
            const otherDays = Array.from(allDays)
                .filter(d => d !== today)
                .sort((a, b) => b.localeCompare(a));
            const orderedDays = [today, ...otherDays];

            elements.tabs.innerHTML = '';

            orderedDays.forEach(day => {
                const tabEl = document.createElement('div');
                tabEl.className = 'tab' + (day === state.openDay ? ' active' : '');
                tabEl.textContent = day === today ? 'Today' : day;
                tabEl.title = day;
                tabEl.addEventListener('click', () => setOpenDay(day));
                elements.tabs.appendChild(tabEl);
            });
        }

        function renderTable() {
            const entries = state.days[state.openDay] || [];
            elements.tbody.innerHTML = '';

            entries.forEach((entry, index) => {
                const row = createTableRow(entry, index, entries);
                elements.tbody.appendChild(row);
            });
        }

        function createTableRow(entry, index, entries) {
            const tr = document.createElement('tr');
            tr.draggable = true;
            tr.className = 'draggable';

            // Drag and drop handlers
            tr.ondragstart = (ev) => {
                ev.dataTransfer.setData('text/plain', index);
            };
            tr.ondragover = (ev) => ev.preventDefault();
            tr.ondrop = (ev) => {
                ev.preventDefault();
                const from = +ev.dataTransfer.getData('text/plain');
                const to = index;

                if (from !== to) {
                    const item = entries.splice(from, 1)[0];
                    entries.splice(to, 0, item);
                    saveState();
                    renderAll();
                }
            };

            // Create cells
            tr.appendChild(createTimeCell(entry, 'start'));
            tr.appendChild(createTimeCell(entry, 'end'));
            tr.appendChild(createDescriptionCell(entry));
            tr.appendChild(createDeleteCell(index, entries));

            return tr;
        }

        function createTimeCell(entry, field) {
            const td = document.createElement('td');
            const input = document.createElement('input');
            input.type = 'time';
            input.step = 60;
            input.value = entry[field] || '';
            input.oninput = () => {
                entry[field] = input.value;
                saveState();
                renderSummary();
                updateDayTotal();
            };
            td.appendChild(input);
            return td;
        }

        function createDescriptionCell(entry) {
            const td = document.createElement('td');
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Description';
            input.value = entry.desc || '';
            input.oninput = () => {
                entry.desc = input.value;
                saveState();
                renderSummary();
            };
            td.appendChild(input);
            return td;
        }

        function createDeleteCell(index, entries) {
            const td = document.createElement('td');
            td.style.textAlign = 'center';

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'danger-small';
            deleteBtn.textContent = 'Delete';
            deleteBtn.onclick = () => {
                if (confirm('Delete this entry?')) {
                    entries.splice(index, 1);
                    saveState();
                    renderAll();
                }
            };

            td.appendChild(deleteBtn);
            return td;
        }

        function renderSummary() {
            const entries = state.days[state.openDay] || [];
            const totals = new Map();

            // Calculate totals by description
            for (const entry of entries) {
                const start = parseHM(entry.start);
                const end = parseHM(entry.end);

                if (start !== null && end !== null && end >= start) {
                    const minutes = end - start;
                    const key = entry.desc || '(no description)';
                    totals.set(key, (totals.get(key) || 0) + minutes);
                }
            }

            if (totals.size === 0) {
                elements.summary.innerHTML = '<div class="muted">Summary will appear here for completed entries.</div>';
                return;
            }

            // Build summary table
            let html = '<table style="width:100%;"><thead><tr><th style="text-align:left;">Description</th><th style="text-align:right;">Total (h:mm)</th></tr></thead><tbody>';

            [...totals.entries()]
                .sort((a, b) => a[0].localeCompare(b[0]))
                .forEach(([desc, minutes]) => {
                    html += `<tr><td>${escapeHtml(desc)}</td><td style="text-align:right;">${fmtHM(minutes)}</td></tr>`;
                });

            html += '</tbody></table>';
            elements.summary.innerHTML = html;
        }

        function updateRunningUI() {
            const entries = state.days[state.openDay] || [];
            const running = findLast(entries, e => e.start && !e.end);
            elements.runningPill.style.display = running ? 'inline-flex' : 'none';
        }

        function updateDayTotal() {
            const entries = state.days[state.openDay] || [];
            let totalMinutes = 0;

            for (const entry of entries) {
                const start = parseHM(entry.start);
                const end = parseHM(entry.end);

                if (start !== null && end !== null && end >= start) {
                    totalMinutes += (end - start);
                }
            }

            elements.dayTotal.textContent = totalMinutes ? `Day total: ${fmtHM(totalMinutes)}` : '';
        }

        function focusLastDescription() {
            const inputs = elements.tbody.querySelectorAll('input[type="text"]');
            if (inputs.length) {
                inputs[inputs.length - 1].focus();
            }
        }

        // === INITIALIZATION ===
        renderAll();
    })();
</script>
</body>
</html>